<div class="container">
    <div>
        <mat-card>
            <h2 i18n="@@api_interface">API Interface</h2>
        </mat-card>
    </div>
    <div>
        <h3 matLine i18n="@@api_notice">Please copy the following API Key string if you want to manage this gateway by
            external control panel.</h3>
        <span class="wrapkey">{{ rpcService.hexAPIKey }}</span>
        <div>
            <h2 i18n="@@1_introduction_to_api">1 Introduction to API Interface</h2>

            <h4>1.1 Interface Address</h4>
            <p>
                All operations of the API use the POST method.
                If "primary_node" -&gt; "admin" -&gt; "listen" in config.json is false, then remove the ":9080".
            </p>
            <code>
                POST http://IP_or_Domain_Name:9080/janusec-admin/ui-api                              
            </code>

            <h4>1.2 Content-Type</h4>
            <code>
                Content-Type: application/json
            </code>

            <h4>1.3 JSON Body for get object(s)</h4>
            <code>
                {{ '{' }}"auth_key":"...", "action":"...", "id":"..."{{ '}' }}
            </code>
            <p>
                id is a snowflake id string, not a number, because it exceeds the range of number.
                id is required for one object, not required for objects list.
            </p>

            <h4>1.4 Response of objects list</h4>
            <code>
        {{ '{' }}"err":null,"object":[...]{{ '}' }}
            </code>

            <h4>1.5 Response of one object</h4>
            <code>
        {{ '{' }}"err":null,"object":{{ '{' }}...{{ '}' }} {{ '}' }}
            </code>

            <h4>1.6 JSON Body for creating or updating an object</h4>
            <p> Let id = '0' for creating an object.</p>
            <code>
        {{ '{' }}"auth_key":"...", "action":"...", "id":"...", "object":...{{ '}' }}
            </code>

            <h4>1.7 Response of updation one object</h4>
            <p>Please keep the format of the object the same with you get it, and if the object has a time parameter,
                skip it or set it to 0.</p>
            <code>
        {{ '{' }}"err":null,"object":{{ '{' }}...{{ '}' }} {{ '}' }}
            </code>

            <h4>1.8 JSON Body for deletion an object</h4>
            <code>
                {{ '{' }}"auth_key":"...", "action":"...", "id":"..."{{ '}' }}
            </code>

            <h4>1.9 Response of deletion one object</h4>
            <code>
        {{ '{' }}"err":null{{ '}' }}
            </code>

            <h2 i18n="@@2_parameters">2 Parameters</h2>

            <h4>2.1 Parameter: auth_key</h4>
            <p>
                The auth_key is a time-related parameter, please make sure the time is correct.
                The auth_key needs to be regenerated every time a request is submitted, it is generated by function
                GenAuthKey(hex.DecodeString(APIKey)) and it is used to verify the identity of the requester.
            </p>
            <code><pre>
    auth_key := GenAuthKey(hex.DecodeString(APIKey))    

    func GenAuthKey(key []byte) string {{ '{' }}
        authTime := AuthTime{{ '{' }}
            CurTime: time.Now().Unix()
        {{ '}' }}
        authTimeBytes, err := json.Marshal(authTime)
        if err != nil {{ '{' }}
            fmt.Println("GenAuthKey", err)
        {{ '}' }}
        encryptedAuthBytes := EncryptWithKey(authTimeBytes, key)
        return hex.EncodeToString(encryptedAuthBytes)
    {{ '}' }}

    type AuthTime struct {{ '{' }}
        CurTime int64 `json:"cur_time"`
    {{ '}' }}

    func EncryptWithKey(plaintext []byte, key []byte) []byte {{ '{' }}
        block, err := aes.NewCipher(key)
        if err != nil {{ '{' }}
            fmt.Println("EncryptWithKey NewCipher", err)
        {{ '}' }}
        nonce := make([]byte, 12)
        _, err = io.ReadFull(rand.Reader, nonce)
        if err != nil {{ '{' }}
            fmt.Println("EncryptWithKey ReadFull", err)
        {{ '}' }}
        aesgcm, err := cipher.NewGCM(block)
        if err != nil {{ '{' }}
            fmt.Println("EncryptWithKey NewGCM", err)
        {{ '}' }}
        ciphertext := aesgcm.Seal(nonce, nonce, plaintext, nil)
        return ciphertext
    {{ '}' }}

            </pre></code>

            <h4>2.2 Parameter: action</h4>
            <p>The parameter action can take the following values (string):</p>
            <ul>
                <li>
                    get_certs: get all digital certificates, not include acme automatic certificates. The result will
                    not include the private key of certificates.
                </li>
                <li>
                    get_cert: get digital certificate with designated id, parameter id (string) is required.
                </li>
                <li>
                    get_apps: get all web applications.
                </li>
                <li>
                    get_app: get the web application with designated id, parameter id (string) is required.
                </li>
                <li>
                    get_vip_apps: get all virtual IP applications, i.e. TCP/UDP port forwarding applications.
                </li>
                <li>
                    get_vip_app: get the virtual IP applications with designated id (string).
                </li>
                <li>
                    get_vuln_types: get all vulnerability types.
                </li>
                <li>
                    get_group_policies: get all group policies/rules for WAF.
                </li>
                <li>
                    get_group_policy: get the group policy/rule for WAF with designated id (string).
                </li>
                <li>
                    get_cc_policy: get CC policy with designated application id, parameter id is required and
                    use application id string here, '0' for all applications.
                </li>
                <li>
                    update_cert: update the digital certificate with designated id (string), if id = '0' then create a
                    new digital certificate.
                </li>
                <li>
                    update_app: update the web application with designated id (string), if id = '0' then create a new
                    web application.
                </li>
                <li>
                    update_vip_app: update the virtual IP application, if id = '0' then create a new port forwarding.
                </li>
                <li>
                    del_cert: delete the digital certificate with designated id (string).
                </li>
                <li>
                    del_app: delete the web application with designated id (string).
                </li>
                <li>
                    del_vip_app: delete the virtual IP application with designated id (string).
                </li>
                <li>
                    del_group_policy: delete the group policy/rule for WAF with designated id (string).
                </li>
                <li>
                    del_cc_policy: delete the CC policy/rule for designated web application.
                </li>
            </ul>

            <h2 i18n="@@3_example">3 Example</h2>
            <p>To update a web application, the body would like the following (Its format should be single line, without
                spaces or line breaks):</p>
            <code><pre>
    {{ '{' }}
        "auth_key":"...",
        "action":"update_app",
        "id":"1642051816726204416",
        "object":{{ '{' }}
            "id":"1642051816726204416",
            "name":"Test",
            "internal_scheme":"http",
            "destinations":[{{ '{' }}
                "id":"1642051816839450624",
                "route_type":1,
                "request_route":"/",
                "backend_route":"/",
                "destination":"127.0.0.1:5000",
                "pods_api":"",
                "pod_port":"80",
                "pods":"",
                "app_id":"1642051816726204416",
                "node_id":"0",
                "online":true,
                "check_time":0
            {{ '}' }}],
            "domains":[{{ '{' }}
                "id":"1642051816931725312",
                "name":"www.example.com",
                "app_id":"1642051816726204416",
                "cert_id":"1642094823705939968",
                "redirect":false,
                "location":""
            {{ '}' }}],
            "redirect_https":false,
            "hsts_enabled":false,
            "waf_enabled":true,
            "shield_enabled":false,
            "ip_method":1,
            "description":"Test",
            "oauth_required":false,
            "session_seconds":7200,
            "owner":"admin",
            "csp_enabled":false,
            "csp":"",
            "cache_enabled":true
        {{ '}' }}
    {{ '}' }}
            </pre></code>

            <p>
                Parameter route_type: 1 for Reverse_Proxy (default), 2 for Local_FastCGI, 4 for Static_Website, 8 for
                K8S_Ingress.
            </p>
            <p>
                Parameter node_id is not used now.
            </p>
            <p>
                Parameter ip_method: 1 for REMOTE_ADDR (default), 2 for X_Forwarded_For, 4 for X_REAL_IP, 8 for REAL_IP
            </p>
            <p>
                Please set id = '0' for new object (such as certificate, application, virtual ip application,
                destination, domain, group policy, cc policy etc.).
            </p>

        </div>
    </div>
</div>